traffic:
  pipeline:
    - run: add_metadata
      parameters:
        name: israel_traffic_violations
        sources:
          - name: Traffic violations data received from FOI requests. Contains data for years 2012-2016 and partial 2017.
            path: sources/traffic-2012-2016-partial-2017.xls
    - run: add_resource
      parameters:
        name: traffic-2012-2016-partial-2017-sheet-1
        description: ''
        url: "./data/traffic/sources/traffic-2012-2016-partial-2017.xls"
        format: xls
        skip_rows: 5
        sheet: 1
        headers:
          - place_name
          - place_type
          - 2012_q1
          - 2012_q2
          - 2012_q3
          - 2012_q4
          - 2012_total
          - 2013_q1
          - 2013_q2
          - 2013_q3
          - 2013_q4
          - 2013_total
          - 2014_q1
          - 2014_q2
          - 2014_q3
          - 2014_q4
          - 2014_total
          - 2015_q1
          - 2015_q2
          - 2015_q3
          - 2015_q4
          - 2015_total
          - 2016_q1
          - 2016_q2
          - 2016_q3
          - 2016_q4
          - 2016_total
          - 2017_q1
          - 2017_q2
          - 2017_total
          - total
    - run: add_resource
      parameters:
        name: traffic-2012-2016-partial-2017-sheet-2
        description: 'נתוני עבירות תנועה שהתקבלו כמענה לבקשת חופש מידע ברמת רשויות מקומיות לשנים 2012-2016 ובנוסף חלק משנת 2017'
        url: "./data/traffic/sources/traffic-2012-2016-partial-2017.xls"
        format: xls
        skip_rows: 1
        sheet: 2
        headers:
          - place_name
          - place_type
          - year
          - quarter
          - value
    - run: add_resource
      parameters:
        name: traffic-2012-2016-partial-2017-sheet-3
        description: 'נתוני עבירות תנועה שהתקבלו כמענה לבקשת חופש מידע ברמת רשויות מקומיות לשנים 2012-2016 ובנוסף חלק משנת 2017'
        url: "./data/traffic/sources/traffic-2012-2016-partial-2017.xls"
        format: xls
        skip_rows: 5
        sheet: 3
        headers:
          - place_name
          - place_type
          - 2012_q1
          - 2012_q2
          - 2012_q3
          - 2012_q4
          - 2012_total
          - 2013_q1
          - 2013_q2
          - 2013_q3
          - 2013_q4
          - 2013_total
          - 2014_q1
          - 2014_q2
          - 2014_q3
          - 2014_q4
          - 2014_total
          - 2015_q1
          - 2015_q2
          - 2015_q3
          - 2015_q4
          - 2015_total
          - 2016_q1
          - 2016_q2
          - 2016_q3
          - 2016_q4
          - 2016_total
          - 2017_q1
          - 2017_q2
          - 2017_total
          - total
    - run: stream_remote_resources
    - run: traffic_normalize
      parameters:
        resource: traffic-2012-2016-partial-2017-sheet-1
        source_sheet: 1
    - run: traffic_normalize
      parameters:
        resource: traffic-2012-2016-partial-2017-sheet-2
        source_sheet: 2
        only_schema: true
    - run: traffic_normalize
      parameters:
        resource: traffic-2012-2016-partial-2017-sheet-3
        source_sheet: 3
    - run: concatenate
      parameters:
        sources: 'traffic-2012-2016-partial-2017-sheet-[0-9]'
        fields:
          place_name: []
          place_type: []
          year_quarter: []
          value: []
          source_sheet: []
        target:
          name: traffic-2012-2016-partial-2017
    - run: plus_plus.enumerate
      parameters:
        resource: traffic-2012-2016-partial-2017
        primary-key: true
        field: id
    - run: plus_plus.dump_to_sql
      parameters:
        resource: traffic-2012-2016-partial-2017
        table: ilcrime_traffic
    - run: plus_plus.dump_to_elasticsearch
      parameters:
        resource: traffic-2012-2016-partial-2017
        index-name: ilcrime_traffic
        drop-index: true
    - run: dump.to_path
      parameters:
        out-path: ./data/traffic
